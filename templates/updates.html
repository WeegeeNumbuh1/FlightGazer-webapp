<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightGazer - Check for Updates</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body { background: #181818; color: #fff; }
        .centered { text-align: center; margin-top: 60px; }
        .back-btn { margin-top: 40px; }
    </style>
</head>
<body>
    <div class="container py-4">
        <a href="/" class="btn btn btn-info">&larr; Back to Home</a>
        <h2 class="mb-4">Check for Updates</h2>
    </div>
    <button id="themeToggleBtn" class="btn btn-outline-info mb-3 float-end" style="position:absolute;top:18px;right:24px;z-index:10;">Switch Theme ‚òÄÔ∏èüåô</button>
    <div class="container py-4">
        <div class="mb-3">
            <button id="checkUpdatesBtn" class="btn btn-success">Check Now</button>
            <span id="versionInfo" style="margin-left:16px;"></span>
        </div>
        <div id="changelogSection" style="display:none;">
            <h5>Changes Since Current Version</h5>
            <iframe id="changelogFrame" style="width:100%;height:220px;background:#222;color:#ffffff;font-family:monospace;border-radius:8px;border:none;"></iframe>
            <div class="mt-3 mb-2">
                <button id="updateNowBtn" class="btn btn-warning">Update Now</button>
            </div>
        </div>
        <div id="updateOutputSection" style="display:none;">
            <h5></h5>Update Output</h5>
            <iframe id="updateOutputFrame" style="width:100%;height:220px;background:#222;color:#ffffff;font-family:monospace;border-radius:8px;border:none;"></iframe>
        </div>
    </div>
    <script>
    function setTheme(theme) {
        if (theme === 'light') {
            document.body.style.background = '#f8f9fa';
            document.body.style.color = '#222';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#fffbe6'; a.style.color = '#b58900'; });
        } else {
            document.body.style.background = '#181818';
            document.body.style.color = '#fff';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#222'; a.style.color = '#a78e04'; });
        }
    }
    function getPreferredTheme() {
        if (localStorage.getItem('fg_theme')) return localStorage.getItem('fg_theme');
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function toggleTheme() {
        let current = getPreferredTheme();
        let next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('fg_theme', next);
        setTheme(next);
    }
    document.getElementById('themeToggleBtn').onclick = toggleTheme;
    setTheme(getPreferredTheme());
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('fg_theme')) setTheme(e.matches ? 'dark' : 'light');
    });
    let updateRunning = false;
    let updatePrompted = false;
    let updateLines = [];
    let changelogContent = '';
    document.getElementById('checkUpdatesBtn').onclick = function() {
        document.getElementById('versionInfo').innerText = 'Checking...';
        fetch('/updates/check', {method:'POST'}).then(r => r.json()).then(data => {
            if (data.error) {
                document.getElementById('versionInfo').innerText = data.error;
                return;
            }
            document.getElementById('versionInfo').innerText = `Current Version: ${data.local_version} | Latest Version: ${data.latest_version}`;
            changelogContent = data.changelog || 'No changelog available.';
            document.getElementById('changelogSection').style.display = '';
            let doc = document.getElementById('changelogFrame').contentDocument;
            doc.open();
            doc.write(`<pre style='background:#222;color:#ffffff;font-family:monospace;font-size:1em;margin:0;padding:12px;'>${changelogContent.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>`);
            doc.close();
        });
    };
    document.getElementById('updateNowBtn').onclick = function() {
        document.getElementById('updateNowBtn').disabled = true; // Disable button after click
        document.getElementById('updateOutputSection').style.display = '';
        let doc = document.getElementById('updateOutputFrame').contentDocument;
        doc.open();
        doc.write('<pre style="background:#222;color:#ffffff;font-family:monospace;font-size:1em;margin:0;padding:12px;">Starting update...</pre>');
        doc.close();
        fetch('/updates/start', {method:'POST'}).then(r => r.json()).then(data => {
            if (data.status === 'started') {
                pollUpdateOutputIframe();
                setTimeout(() => sendUpdateInput('y'), 1200); // auto-confirm
            } else {
                let doc = document.getElementById('updateOutputFrame').contentDocument;
                doc.open();
                doc.write('<pre style="background:#222;color:#ffffff;font-family:monospace;font-size:1em;margin:0;padding:12px;">Update already running.</pre>');
                doc.close();
            }
        });
    };
    function sendUpdateInput(val) {
        fetch('/updates/input', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({input:val})});
    }
    function pollUpdateOutputIframe() {
        fetch('/updates/output').then(r => r.json()).then(data => {
            if (data.lines && data.lines.length) {
                let doc = document.getElementById('updateOutputFrame').contentDocument;
                doc.open();
                let prev = doc.body ? doc.body.innerText : '';
                let newText = (prev ? prev : '') + data.lines.join('');
                doc.write(`<pre style='background:#222;color:#ffffff;font-family:monospace;font-size:1em;margin:0;padding:12px;'>${newText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>`);
                doc.close();
            }
            updateRunning = data.running;
            if (updateRunning) setTimeout(pollUpdateOutputIframe, 1000);
        });
    }
    </script>
</body>
</html>
