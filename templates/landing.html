<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlightGazer - Home ({{ hostname }} at {{ ip_address }})</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body { background: #181818; color: #fff; padding-bottom: 72px; }
        .logo-container { text-align: center; margin-top: 24px; }
        .logo-img { max-width: 340px; width: 100%; height: auto; }
        .version-text { text-align: center; font-size: 1em; margin: 12px 0 32px 0; }
        .main-btns { display: flex; flex-direction: column; align-items: center; gap: 22px; margin-top: 10px; }
        .main-btns .btn { min-width: 260px; font-size: 1.15em; }
        .quick-access-btns { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-top: 10px; }
        .quick-access-btns .btn { width: 260px; }
        .footer { text-align: left; position: fixed; bottom: 24px; left: 24px; font-size: 0.5em; color:rgba(169, 169, 169, 0.6)}
        .small-status {text-align: center; font-size: 0.6em; color:grey;}
    </style>
</head>
<body>
    <div id="top-buttons" class="container py-4">
    <button id="themeToggleBtn" class="btn btn-sm btn-outline-info mb-3 float-end" style="position:absolute;top:1.5rem;right:0.75rem;z-index:10;" title="Change Theme">‚òÄÔ∏èüåô</button>
    <button id="bookmarkBtn" class="btn btn-sm btn-outline-secondary mb-3 float-end" style="position:absolute;top:1.5rem;left:0.75rem;z-index:9;" title="About">‚≠ê</button>
    </div>
    {% set status_color = '#3ecf4a' if status == 'running' else ('#888' if status == 'stopped' else '#e53935') %}
    <div class="logo-container">
        <a href="https://github.com/WeegeeNumbuh1/FlightGazer" target="_blank" rel="noopener noreferrer" title="View the project on GitHub">
            <img src="{{ url_for('static', filename='FlightGazer-logo.png') }}" alt="FlightGazer Logo" class="logo-img">
        </a>
    </div>
    <div class="status-indicator" style="text-align:center; margin-top:10px; margin-bottom:2px;">
        <span style="display:inline-block; width:18px; height:18px; border-radius:50%; vertical-align:middle; margin-right:7px; background: {{ status_color }}; border: 2px solid #222;"></span>
        <span style="font-size:1.05em; vertical-align:middle;">
            {% if status == 'running' %}FlightGazer is running
            {% elif status == 'stopped' %}FlightGazer is not running
            {% elif status == 'manually running' %}FlightGazer has been started manually
            {% elif status == 'degraded' %}FlightGazer is degraded (check the logs)
            {% else %}FlightGazer status error (check the logs){% endif %}
        </span>
        <div style="position: relative;margin: auto;width: 60%;">
            <span class="small-status" id="device-info"></span>
        </div>
        <div id="serviceStatus" style="position: relative;margin: auto;width: 60%;">
            <span id="serviceStatusMsg" style="color:#ffd700;text-align: center;"></span>
        </div>
    </div>
    <div class="version-text">
        Version {{ version }}
    </div>
    <div class="footer">
        <!-- web-app <a href="https://github.com/WeegeeNumbuh1/FlightGazer-webapp" target="_blank" rel="noopener noreferrer" title="View the source code">v.{{ webapp_version }}</a>
        <br><i>Made by WeegeeNumbuh1</i> -->
    </div>
    <div class="main-btns">
        <a href="{{ url_for('config_page') }}" class="btn btn-primary">Configure Settings</a>
        <a href="{{ url_for('details_page') }}" class="btn btn-secondary">Details and Logs</a>
        <a href="{{ url_for('updates_page') }}" class="btn btn-secondary">Check for Updates</a>
        <a href="{{ url_for('startup_options') }}" class="btn btn-secondary">Change Startup Options</a>
        <a href="{{ url_for('reference_guide') }}" class="btn btn-secondary" target="_blank">Help &amp; Reference</a>
    </div>
    <div class="quick-access-btns" style="margin-top:32px; text-align:center;">
        {% if localpages %}
            Quick links (opens a new tab)<br>
            {% for label, url in localpages.items() %}
                <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary" style="margin:6px 8px; min-width:220px;">{{ label }}</a>
            {% endfor %}
        {% endif %}
    </div>
    <div id="serviceControlBtns" style="position:fixed;bottom:24px;right:24px;z-index:1000;">
        <button id="startServiceBtn" class="btn btn-success me-2" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Start FlightGazer">Start</button>
        <button id="restartServiceBtn" class="btn btn-warning me-2" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Restart FlightGazer">Restart</button>
        <button id="stopServiceBtn" class="btn btn-danger" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Stop FlightGazer">Stop</button>
    </div>
    <script>
    const statusURL = "{{ url_for('service_status') }}";
    const serviceRestart = "{{ url_for('restart_flightgazer') }}";
    const serviceStop = "{{ url_for('stop_flightgazer_service') }}";
    const serviceStart = "{{ url_for('start_flightgazer_service') }}";
    function setTheme(theme) {
        if (theme === 'light') {
            document.body.style.background = '#f8f9fa';
            document.body.style.color = '#222';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#fffbe6'; a.style.color = '#b58900'; });
        } else {
            document.body.style.background = '#181818';
            document.body.style.color = '#fff';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#222'; a.style.color = '#ffd700'; });
        }
    }
    function getPreferredTheme() {
        if (localStorage.getItem('fg_theme')) return localStorage.getItem('fg_theme');
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function toggleTheme() {
        let current = getPreferredTheme();
        let next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('fg_theme', next);
        setTheme(next);
    }
    document.getElementById('themeToggleBtn').onclick = toggleTheme;
    setTheme(getPreferredTheme());
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('fg_theme')) setTheme(e.matches ? 'dark' : 'light');
    });
    function disableServiceBtns() {
        document.getElementById('startServiceBtn').disabled = true;
        document.getElementById('restartServiceBtn').disabled = true;
        document.getElementById('stopServiceBtn').disabled = true;
        setTimeout(function() {
            document.getElementById('startServiceBtn').disabled = false;
            document.getElementById('restartServiceBtn').disabled = false;
            document.getElementById('stopServiceBtn').disabled = false;
        }, 20000);
    }
    function confirmAction(msg, cb) {
        if (window.confirm(msg)) cb();
    }
    document.getElementById('startServiceBtn').onclick = function() {
        confirmAction('Start FlightGazer service?', function() {
            disableServiceBtns();
            document.getElementById('serviceStatusMsg').innerText = 'Starting...';
            fetch(serviceStart, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'already_running') {
                    document.getElementById('serviceStatusMsg').innerText = 'FlightGazer is already running.';
                    alert('FlightGazer is already running.');
                } else if (data.status === 'started') {
                    document.getElementById('serviceStatusMsg').innerText = 'Service started.';
                } else {
                    document.getElementById('serviceStatusMsg').innerText = data.error || 'Error.';
                }
            });
        });
    };
    document.getElementById('restartServiceBtn').onclick = function() {
        confirmAction('Restart FlightGazer service?', function() {
            disableServiceBtns();
            document.getElementById('serviceStatusMsg').innerText = 'Restarting...';
            fetch(serviceRestart, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    document.getElementById('serviceStatusMsg').innerText = 'Service successfully restarted.';
                } else {
                    document.getElementById('serviceStatusMsg').innerText = data.error || 'Error.';
                }
            });
        });
    };
    document.getElementById('stopServiceBtn').onclick = function() {
        confirmAction('Stop FlightGazer service?', function() {
            disableServiceBtns();
            document.getElementById('serviceStatusMsg').innerText = 'Stopping...';
            fetch(serviceStop, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'stopped') {
                    document.getElementById('serviceStatusMsg').innerText = 'Service stopped.';
                } else {
                    document.getElementById('serviceStatusMsg').innerText = data.error || 'Error.';
                }
            });
        });
    };
    document.getElementById("bookmarkBtn").addEventListener("click", function() {
        alert('This is the FlightGazer-webapp (v.{{ webapp_version }}), made by WeegeeNumbuh1.\n\n\
To see the source code, click the FlightGazer logo on this page.\n\n\
It\'s recommended to bookmark this page for easy access.\n\
- If you\'re on a computer, press ' + (navigator.userAgent.toLowerCase().indexOf('mac') != - 1 ? 'Command/Cmd' : 'CTRL') + ' + D to bookmark this page.\n\
- If you\'re using a mobile device, open your browser\'s menu and select the option to bookmark this page.')
  });
    document.getElementById("device-info").innerText = 'Running on {{ hostname }} at {{ ip_address }}'
    function updateStatusIndicator() {
        fetch(statusURL).then(r => r.json()).then(data => {
            let status = data.status;
            let statusText = '';
            let statusColor = '#ffffff00';
            if (status === 'running') {
                statusColor = '#3ecf4a';
                statusText = 'FlightGazer is running';
            } else if (status === 'stopped') {
                statusColor = '#888';
                statusText = 'FlightGazer is not running';
            } else if (status === 'manually running') {
                statusColor = '#ffd710';
                statusText = 'FlightGazer has been started manually';
            } else if (status === 'failed') {
                statusColor = '#e53935';
                statusText = 'FlightGazer status error (check the logs)';
            } else if (status === 'degraded') {
                statusColor = '#ffd710';
                statusText = 'FlightGazer is degraded (check the logs)';
            }
            document.querySelector('.status-indicator span').style.background = statusColor;
            document.querySelector('.status-indicator span + span').innerText = statusText;
        });
    }
    let statusPollingInterval;

    function startStatusPolling() {
        if (!statusPollingInterval) {
            updateStatusIndicator();
            statusPollingInterval = setInterval(updateStatusIndicator, 10000);
        }
    }

    function stopStatusPolling() {
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
    }

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopStatusPolling();
        } else {
            startStatusPolling();
        }
    });

    // Initial call and start polling
    startStatusPolling();
    </script>
</body>
</html>
