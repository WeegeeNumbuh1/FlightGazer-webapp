<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <title>FlightGazer - Home ({{ hostname }} at {{ ip_address }})</title>
    <meta name="author" content="WeegeeNumbuh1">
    <meta name="description" content="FlightGazer main landing page.">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        body { background: #181818; color: #fff; padding-bottom: 72px; }
        .logo-container { text-align: center; margin-top: 24px; }
        .logo-img { max-width: 340px; width: 100%; height: auto; }
        .version-text { text-align: center; font-size: 1em; margin: 12px 0 32px 0; }
        .main-btns { display: flex; flex-direction: column; align-items: center; gap: 22px; margin-top: 10px; }
        .main-btns .btn { min-width: 260px; font-size: 1.15em; }
        .quick-access-btns { display: flex; flex-direction: column; align-items: center; gap: 12px; margin-top: 10px; }
        .quick-access-btns .btn { width: 260px; }
        .footer { text-align: left; position: fixed; bottom: 24px; left: 24px; font-size: 0.5em; color:rgba(169, 169, 169, 0.6)}
        .small-status {text-align: center; font-size: 0.6em; color:grey;}
    </style>
</head>
<body>
    <div id="top-buttons" class="container py-4">
    <button id="themeToggleBtn" class="btn btn-sm btn-outline-info mb-3 float-end" style="position:absolute;top:1.5rem;right:0.75rem;z-index:10;" title="Change Theme">‚òÄÔ∏èüåô</button>
    <button id="bookmarkBtn" class="btn btn-sm btn-outline-secondary mb-3 float-end" style="position:absolute;top:1.5rem;left:0.75rem;z-index:9;" title="About">‚≠ê</button>
    </div>
    {% set status_color = '#3ecf4a' if status == 'running' else ('#888' if status == 'stopped' else '#e53935') %}
    <div class="logo-container">
        <a href="https://github.com/WeegeeNumbuh1/FlightGazer" target="_blank" rel="noopener noreferrer" title="View the project on GitHub">
            <img src="{{ url_for('static', filename='FlightGazer-logo.png') }}" alt="FlightGazer Logo" class="logo-img">
        </a>
    </div>
    <noscript>
        <div class="container py-4" style="text-align:center; margin-top:10px; margin-bottom:2px;">
        <p>
        <h2>JavaScript is disabled in your browser.<br>
            This is required for this web-app to work.<br>
            Please enable JavaScript.</h2>
        </p>
        </div>
    </noscript>
    <div class="status-indicator" style="text-align:center; margin-top:10px; margin-bottom:2px;">
        <span style="display:inline-block; width:18px; height:18px; border-radius:50%; vertical-align:middle; margin-right:7px; background: {{ status_color }}; border: 2px solid #222;"></span>
        <span style="font-size:1.05em; vertical-align:middle;">
            {% if status == 'running' %}FlightGazer is running
            {% elif status == 'stopped' %}FlightGazer is not running
            {% elif status == 'manually running' %}FlightGazer has been started manually
            {% elif status == 'degraded' %}FlightGazer is degraded (check the logs)
            {% else %}FlightGazer status error (check the logs){% endif %}
        </span>
        <div style="position: relative;margin: auto;width: 60%;">
            <span class="small-status" id="device-info"></span>
        </div>
        <div id="serviceStatus" style="position: relative;margin: auto;width: 60%;">
            <span id="serviceStatusMsg" style="color:#eda907;text-align: center;"></span>
        </div>
    </div>
    <div class="version-text">
        Version {{ version }}
    </div>
    <div class="footer">
        <!-- web-app <a href="https://github.com/WeegeeNumbuh1/FlightGazer-webapp" target="_blank" rel="noopener noreferrer" title="View the source code">v.{{ webapp_version }}</a>
        <br><i>Made by WeegeeNumbuh1</i> -->
    </div>
    <div class="main-btns">
        <a href="{{ url_for('config_page') }}" class="btn btn-primary">Configure Settings</a>
        <a href="{{ url_for('details_page') }}" class="btn btn-secondary">Details and Logs</a>
        <a href="{{ url_for('updates_page') }}" class="btn btn-secondary">Check for Updates</a>
        <a href="{{ url_for('startup_options') }}" class="btn btn-secondary">Change Startup Options</a>
        <a href="{{ url_for('reference_guide') }}" class="btn btn-secondary" target="_blank">Help &amp; Reference</a>
    </div>
    <div class="quick-access-btns" id="quickAccessBtns" style="margin-top:32px; text-align:center;">
        <!-- Show something (if available) before the page updates this section -->
        {% if localpages %}
            Quick links (opens a new tab)<br>
            {% for label, url in localpages.items() %}
            <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-secondary" style="margin:6px 8px; min-width:220px;">{{ label }}</a>
            {% endfor %}
            <span class="small-status"><i>Refreshing links...</i></span><br>
        {% endif %}
    </div>
    <div id="serviceControlBtns" style="position:fixed;bottom:24px;right:24px;z-index:1000; font-size: 0.7em; color:rgba(169, 169, 169, 0.6)">
        <div id="serviceBtnOverlay" style="z-index: 1001; text-align: right;"></div>
        <button id="startServiceBtn" class="btn btn-success me-2" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Start FlightGazer">Start</button>
        <button id="restartServiceBtn" class="btn btn-warning me-2" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Restart FlightGazer">Restart</button>
        <button id="stopServiceBtn" class="btn btn-danger" style="box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19)" title="Stop FlightGazer">Stop</button>
    </div>

    <script>
    const statusURL = "{{ url_for('service_status') }}";
    const serviceRestart = "{{ url_for('restart_flightgazer') }}";
    const serviceStop = "{{ url_for('stop_flightgazer_service') }}";
    const serviceStart = "{{ url_for('start_flightgazer_service') }}";
    const localPagesURL = "{{ url_for('api_localpages') }}";
    const SERVICE_BTN_DISABLE_KEY = 'fg_service_buttons_disabled_until';
    const SERVICE_BTN_TIMEOUT_MS = 30000;
    function setTheme(theme) {
        if (theme === 'light') {
            document.body.style.background = '#f8f9fa';
            document.body.style.color = '#222';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#fffbe6'; a.style.color = '#b58900'; });
        } else {
            document.body.style.background = '#181818';
            document.body.style.color = '#fff';
            let alerts = document.querySelectorAll('.alert');
            alerts.forEach(a => { a.style.background = '#222'; a.style.color = '#eda907'; });
        }
    }
    function getPreferredTheme() {
        if (localStorage.getItem('fg_theme')) return localStorage.getItem('fg_theme');
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function toggleTheme() {
        let current = getPreferredTheme();
        let next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('fg_theme', next);
        setTheme(next);
    }
    document.getElementById('themeToggleBtn').onclick = toggleTheme;
    setTheme(getPreferredTheme());
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (!localStorage.getItem('fg_theme')) setTheme(e.matches ? 'dark' : 'light');
    });

    function setButtonsDisabled(disabled) {
        ['startServiceBtn', 'restartServiceBtn', 'stopServiceBtn'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.disabled = disabled;
        });
    }

    function saveDisableUntil(ts) {
        try { localStorage.setItem(SERVICE_BTN_DISABLE_KEY, String(ts)); } catch(e) {}
    }

    function clearDisableUntil() {
        try { localStorage.removeItem(SERVICE_BTN_DISABLE_KEY); } catch(e) {}
    }

    function scheduleReenable(untilTs) {
        const remaining = Math.max(0, untilTs - Date.now());
        setTimeout(() => {
            // only re-enable if the saved expiry has passed
            const saved = Number(localStorage.getItem(SERVICE_BTN_DISABLE_KEY));
            if (!saved || Date.now() >= saved) {
                setButtonsDisabled(false);
                serviceBtnTxt(false);
                clearDisableUntil();
            }
        }, remaining);
    }

    function serviceBtnTxt(flag) {
        const overlay = document.getElementById('serviceBtnOverlay');
        if (flag === true) {
            showTemporaryMessage('serviceBtnOverlay', 'You can try again in a few moments.', 15000);
        } else {
            overlay.innerText = "";
        }
    }
    function disableServiceBtns() {
        const until = Date.now() + SERVICE_BTN_TIMEOUT_MS;
        const overlay = document.getElementById('serviceBtnOverlay');
        saveDisableUntil(until);
        setButtonsDisabled(true);
        serviceBtnTxt(true);
        scheduleReenable(until);
    }

    function restoreButtonStateFromStorage() {
        try {
            const saved = Number(localStorage.getItem(SERVICE_BTN_DISABLE_KEY));
            if (saved && Date.now() < saved) {
                setButtonsDisabled(true);
                serviceBtnTxt(true);
                scheduleReenable(saved);
            } else {
                setButtonsDisabled(false);
                serviceBtnTxt(false);
                clearDisableUntil();
            }
        } catch (e) {
            // localStorage unavailable ‚Äî default behavior: don't persist
            setButtonsDisabled(false);
        }
    }

    function confirmAction(msg, cb) {
        if (window.confirm(msg)) cb();
    }
    // show a message in an element and clear it after `timeout` ms,
    // but only if the element hasn't been written to again
    function showTemporaryMessage(elemId, message, timeout = 10000) {
        const el = document.getElementById(elemId);
        if (!el) return;
        // per-element message id so older timers don't clear newer messages
        el.dataset.msgId = String((parseInt(el.dataset.msgId || '0', 10) + 1));
        const myId = el.dataset.msgId;
        el.innerText = message;
        if (el._fg_clearTimeout) clearTimeout(el._fg_clearTimeout);
        el._fg_clearTimeout = setTimeout(() => {
            if (el.dataset.msgId === myId) {
                el.innerText = '';
                delete el.dataset.msgId;
                el._fg_clearTimeout = null;
            }
        }, timeout);
    }

    document.getElementById('startServiceBtn').onclick = function() {
        confirmAction('Start FlightGazer service?', function() {
            disableServiceBtns();
            serviceBtnTxt(true);
            document.getElementById('serviceStatusMsg').innerText = 'Starting...';
            fetch(serviceStart, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'already_running') {
                    showTemporaryMessage('serviceStatusMsg', 'FlightGazer is already running.', 15000);
                    alert('FlightGazer is already running.');
                } else if (data.status === 'started') {
                    showTemporaryMessage('serviceStatusMsg', 'Service started.', 15000);
                } else {
                    showTemporaryMessage('serviceStatusMsg', data.error || 'Error.', 60000);
                }
            });
        });
    };
    document.getElementById('restartServiceBtn').onclick = function() {
        confirmAction('Restart FlightGazer service?', function() {
            disableServiceBtns();
            serviceBtnTxt(true);
            document.getElementById('serviceStatusMsg').innerText = 'Restarting...';
            fetch(serviceRestart, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    showTemporaryMessage('serviceStatusMsg', 'Service successfully restarted.', 15000);
                } else {
                    showTemporaryMessage('serviceStatusMsg', data.error || 'Error.', 60000);
                }
            });
        });
    };
    document.getElementById('stopServiceBtn').onclick = function() {
        confirmAction('Stop FlightGazer service?', function() {
            disableServiceBtns();
            serviceBtnTxt(true);
            document.getElementById('serviceStatusMsg').innerText = 'Stopping...';
            fetch(serviceStop, {method:'POST'}).then(r => r.json()).then(data => {
                if (data.status === 'already_stopped') {
                    showTemporaryMessage('serviceStatusMsg', 'FlightGazer is already stopped.', 15000);
                    alert('FlightGazer is already stopped.');
                } else if (data.status === 'stopped') {
                    showTemporaryMessage('serviceStatusMsg', 'Service stopped.', 15000);
                } else {
                    document.getElementById('serviceStatusMsg').innerText = data.error || 'Error.';
                    showTemporaryMessage('serviceStatusMsg', data.error || 'Error.', 60000);
                }
            });
        });
    };
    document.getElementById("bookmarkBtn").addEventListener("click", function() {
        alert('This is the FlightGazer-webapp (v.{{ webapp_version }}), made by WeegeeNumbuh1.\n\n\
To see the source code, click the FlightGazer logo on this page.\n\n\
It\'s recommended to bookmark this page for easy access.\n\
- If you\'re on a computer, press ' + (navigator.userAgent.toLowerCase().indexOf('mac') != - 1 ? 'Command/Cmd' : 'CTRL') + ' + D to bookmark this page.\n\
- If you\'re using a mobile device, open your browser\'s menu and select the option to bookmark this page.')
  });
    document.getElementById("device-info").innerText = 'Running on {{ hostname }} at {{ ip_address }}'
    function updateStatusIndicator() {
        fetch(statusURL).then(r => r.json()).then(data => {
            let status = data.status;
            let statusText = '';
            let statusColor = '#ffffff00';
            if (status === 'running') {
                statusColor = '#3ecf4a';
                statusText = 'FlightGazer is running';
            } else if (status === 'stopped') {
                statusColor = '#888';
                statusText = 'FlightGazer is not running';
            } else if (status === 'manually running') {
                statusColor = '#ffd710';
                statusText = 'FlightGazer has been started manually';
            } else if (status === 'failed') {
                statusColor = '#e53935';
                statusText = 'FlightGazer status error (check the logs)';
            } else if (status === 'degraded') {
                statusColor = '#ffd710';
                statusText = 'FlightGazer is degraded (check the logs)';
            }
            document.querySelector('.status-indicator span').style.background = statusColor;
            document.querySelector('.status-indicator span + span').innerText = statusText;
        }).catch(error => console.error('Could not determine status:', error));
    }
    let statusPollingInterval;

    function startStatusPolling() {
        if (!statusPollingInterval) {
            updateStatusIndicator();
            statusPollingInterval = setInterval(updateStatusIndicator, 10000);
        }
    }

    function stopStatusPolling() {
        if (statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
        }
    }

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopStatusPolling();
        } else {
            startStatusPolling();
        }
    });

    // Initial call and start polling
    startStatusPolling();

    // load and render local pages
    async function loadLocalPages() {
        try {
            const response = await fetch(localPagesURL);
            const localpages = await response.json();
            const quickAccessDiv = document.getElementById('quickAccessBtns');

            if (Object.keys(localpages).length === 0) {
                quickAccessDiv.style.display = 'none';
                return;
            }

            // clear existing content
            quickAccessDiv.innerHTML = 'Quick links (opens a new tab)<br>';

            // add buttons for each local page
            for (const [label, url] of Object.entries(localpages)) {
                const link = document.createElement('a');
                link.href = url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.className = 'btn btn-outline-secondary';
                link.style.margin = '6px 8px';
                link.style.minWidth = '220px';
                link.textContent = label;
                quickAccessDiv.appendChild(link);
            }
            quickAccessDiv.style.display = 'flex';
        } catch (error) {
            // silently fail, don't show error to user
        }
    }

    // keep other tabs/windows in sync
    window.addEventListener('storage', (e) => {
        if (e.key === SERVICE_BTN_DISABLE_KEY) {
            restoreButtonStateFromStorage();
        }
    });

    // call at startup to restore persisted state
    restoreButtonStateFromStorage();
    // load local pages on page load
    loadLocalPages();
    </script>
</body>
</html>
